<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Center Court QR Code Generator</title>
    <link rel="stylesheet" href="css/centercourtStyles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.7/handlebars.min.js"></script>
    <script defer src="/handlebars/handlebars.js"></script>
    <script src="/config.js"></script> <!-- Konfigurationsdatei -->
</head>
<body>
    <h1>QR Code f√ºr Spielcourt</h1>
    <p id="qrCode" class="qrCode"></p> <!-- QR-Code wird hier generiert -->
    
    <!-- Display scanned court info -->
    <div id="courtInfo" style="display:none;">
        <h2>Court Information</h2>
        <p><strong>User ID:</strong> <span id="user_id"></span></p>
        <p><strong>Court Number:</strong> <span id="courtnumber"></span></p>
    </div>

    <div class="input-container">
        <label for="user-input">Center Court Key eingeben:</label>
        <input type="text" id="user-input" placeholder="Enter key">
        <button onclick="showGameOverview()">Submit</button>
    </div>

    <div id="game-overview" >
        <div id="matches-container"></div>
    </div>

    <script id="matches-template" type="text/x-handlebars-template">
        {{#each matches}}
        <div class="CourtBox">    
            <div class="CourtData">
                <span class="Courtnumber">Courtnumber: {{courtnumber}}</span>
                <table class="CourtTable">
                    <thead>
                        <tr class="DisplayGameTitles">
                            <th colspan="1">Spielername</th>
                            <th colspan="1">Set</th>
                            <th colspan="3">Games</th>
                            <th colspan="1">Points</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="spielerverein">{{spieler1_verein}}</td>
                        </tr>
                        <tr>
                            <td class="spielerfeld">{{spieler1}} </td>
                            <td class="spielwerte">{{spieler1_satz}}</td>
                            <td class="spielwerte">{{spieler1_spiel3}}</td>
                            <td class="spielwerte">{{spieler1_spiel2}}</td>
                            <td class="spielwerte">{{spieler1_spiel}}</td>
                            <td class="spielwertePunkte {{#if (eq winnervalue 1)}}disabled{{/if}}">
                                {{#if (eq winnervalue 1)}}
                                    <img src="/Images/trophy.png" alt="Trophy" class="TrophyImage">
                                {{else}}
                                    {{spieler1_punkte}}
                                {{/if}}
                            </td>
                            <td class="serveImage"> {{#if (eq serve1 1)}}<img src="/Images/tennisball.webp">{{/if}}</td>
                        </tr>
                        <tr>
                            <td class="spielerverein">{{spieler2_verein}}</td>
                        </tr>
                        <tr>
                            <td class="spielerfeld">{{spieler2}} </td>
                            <td class="spielwerte">{{spieler2_satz}}</td>
                            <td class="spielwerte">{{spieler2_spiel3}}</td>
                            <td class="spielwerte">{{spieler2_spiel2}}</td>
                            <td class="spielwerte">{{spieler2_spiel}}</td>
                            <td class="spielwertePunkte {{#if (eq winnervalue 2)}}disabled{{/if}}">
                                {{#if (eq winnervalue 2)}}
                                    <img src="/Images/trophy.png" alt="Trophy" class="TrophyImage">
                                {{else}}
                                    {{spieler2_punkte}}
                                {{/if}}
                            </td>
                            <td class="serveImage"> {{#if (eq serve2 1)}}<img src="/Images/tennisball.webp">{{/if}}</td>
                        </tr>
                    </tbody>
                </table>
                <div class="CourtDescription">
                    <span>Spielklasse: {{spielklasse}}</span>
                    <span>Altersklasse: {{altersklasse}}</span>
                </div>
                <div class="CourtDescription2"> 
                    <span>Status: {{spielstatus}}</span>
                    <span>ID: {{id}}</span>
              </div>
            </div>
        </div>
        {{/each}}
    </script>

    <script>
        // Global configuration object
        const config = {
            baseUrl: `http://${IP.ipAddress}:5500`,
            apiBaseUrl: `http://${IP.ipAddress}:3000`
        };

        let allMatches = [];

        // Function to generate the QR code on page load
        async function generateQR() {
            try {
                const response = await fetch(`${config.apiBaseUrl}/generate-center-court-qr`);
                const data = await response.json();
                
                if (data.generated_key) {
                    const qrCodeData = JSON.stringify({ generated_key: data.generated_key });
                    document.getElementById('qrCode').innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(qrCodeData)}&size=150x150" />`;
                    startFetchingCourtInfo(data.generated_key);
                } else {
                    console.error('Generated key not found in response');
                }
            } catch (error) {
                console.error('Fehler beim Generieren des QR-Codes:', error);
            }
        }

        // Fetch and update matches
        async function fetchAndUpdateMatches() {
            try {
                const response = await fetch(`${config.apiBaseUrl}/matches/`);
                const data = await response.json();
                allMatches = data;
                updateMatches();
            } catch (error) {
                console.error('Error fetching match data:', error);
            }
        }

        // Update match view based on filters
        function updateMatches() {
            const filters = getFilters();
            let filteredData = [];

            if (filters.generatedKey) {
                filteredData = allMatches.filter(match => {
                    return match.generated_key && match.generated_key.toString() === filters.generatedKey;
                });
            }

            const matchesContainer = document.getElementById('matches-container');
            const source = document.getElementById('matches-template').innerHTML;
            const template = Handlebars.compile(source);
            const newHtml = template({ matches: filteredData });

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newHtml;

            const newNodes = tempDiv.childNodes;
            const oldNodes = matchesContainer.childNodes;

            for (let i = 0; i < newNodes.length; i++) {
                if (!oldNodes[i] || newNodes[i].outerHTML !== oldNodes[i].outerHTML) {
                    if (oldNodes[i]) {
                        matchesContainer.replaceChild(newNodes[i].cloneNode(true), oldNodes[i]);
                    } else {
                        matchesContainer.appendChild(newNodes[i].cloneNode(true));
                    }
                }
            }
        }

        function getFilters() {
            return { generatedKey: document.getElementById('user-input').value };
        }

        function applyFilters() {
            console.log('Filters applied:', getFilters());
            updateMatches();
        }

////////////////
////Fecth data after QR code scan 
async function fetchCourtInfo(generatedKey) {
    try {
        const response = await fetch(`${config.apiBaseUrl}/display-court/${generatedKey}`, { method: 'GET' });
        const data = await response.json();

        // Log data to check what is actually received
        //console.log("Fetched court data:", data);

        // Check if data is valid and contains the expected fields
        if (data && data.user_id && data.courtnumber) {
            // Populate the user ID and court number fields
            document.getElementById('user_id').textContent = data.user_id;
            document.getElementById('courtnumber').textContent = data.courtnumber;

            // Hide QR code, input container, and court info display
            document.querySelector('.input-container').style.display = 'none';
            document.getElementById('qrCode').style.display = 'none';
            document.getElementById('courtInfo').style.display = 'none';

            // Show game overview in fullscreen
            const gameOverview = document.getElementById('game-overview');
            gameOverview.style.display = 'block';
            gameOverview.classList.add('fullscreen');

            // Apply filters to show the relevant match data
            
        } else {
            console.error('Court information not found or incomplete for the key');
            //alert('Court information not found or incomplete for the provided key.');
        }
    } catch (error) {
        console.error('Error fetching court information:', error);
        alert('An error occurred while fetching court information. Please try again.');
    }
}

        // Start fetching court info every 5 seconds
        function startFetchingCourtInfo(generatedKey) {
            fetchCourtInfo(generatedKey);
            setInterval(() => fetchCourtInfo(generatedKey), 5000);
        }
////////////////
        // Show game overview on match search
        function showGameOverview() {
            const userInput = document.getElementById('user-input').value;
            if (userInput.trim() !== '') {
                document.querySelector('.input-container').style.display = 'none';
                document.getElementById('qrCode').style.display = 'none';
                document.getElementById('courtInfo').style.display = 'none';

        //Show game overview in fullscreen
                const gameOverview = document.getElementById('game-overview');
                gameOverview.style.display = 'block';
                gameOverview.classList.add('fullscreen');
                applyFilters();
            }
        }

        // Run when page loads
        window.onload = function() {
            generateQR();
            fetchAndUpdateMatches();
            setInterval(fetchAndUpdateMatches, 5000); // Update matches every 5 seconds
        };

          // Registering the 'eq' helper in Handlebars
          Handlebars.registerHelper('eq', function(a, b) {
            return a === b;
        });
    </script>
</body>
</html>
